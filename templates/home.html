{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='style1.css') }}">
{% endblock %}

{% block content %}
  {% if not current_user.is_authenticated %}
    <a href="{{ url_for('login') }}">Login</a> or 
    <a href="{{ url_for('register') }}">Create Account</a>
  {% endif %}

  <h2>Choose a Discipline</h2>
  {% set icon_map = {
    'math': 'fa-square-root-alt',
    'physics': 'fa-atom',
    'chemistry': 'fa-flask',
    'biology': 'fa-dna',
    'computer science': 'fa-laptop-code',
    'economics': 'fa-chart-line',
    'medicine': 'fa-stethoscope',
    'statistics': 'fa-chart-bar',
    'robotics': 'fa-robot',
    'engineering': 'fa-gears'
  } %}

  <ul style="list-style:none; padding-left: 0;">
    {% for discipline in disciplines %}
      <li style="display: flex; align-items: center; margin-bottom: 10px;">
        <i class="fas {{ icon_map[discipline] }}" style="width: 20px; min-width: 20px; margin-right: 10px;"></i>
        <a href="{{ url_for('dashboard', tag=discipline) }}" style="text-decoration: none; color: inherit;">
          {{ discipline|capitalize }}
        </a>
      </li>
    {% endfor %}
  </ul>

  <hr>

  <div style="margin-top: 20px;">
    <button id="toggleAllPosts" class="btn btn-primary">View All Posts</button>
  </div>

  <div id="allPostsContainer" class="posts-container"></div>

<script>
let postsLoaded = false;

function loadPosts() {
    if (!postsLoaded) {
        fetch('/get_posts')  // <-- use the correct route
            .then(res => res.json())
            .then(posts => {
                const container = document.getElementById('allPostsContainer');
                container.innerHTML = '';

                posts.forEach(post => {
                    // Tags HTML
                    let tagsHTML = '';
                    if (post.tags && post.tags.length) {
                        post.tags.forEach(tag => {
                            tagsHTML += `<span class="tag-badge">${tag}</span> `;
                        });
                    }

                    // Votes HTML
                    const votesHTML = `
                        <div class="vote-container">
                            <button class="vote-btn upvote ${post.user_upvoted ? 'active' : ''}" onclick="votePost(${post.id}, 1)">&#9650;</button>
                            <span class="vote-count" id="vote-count-${post.id}">${post.votes}</span>
                            <button class="vote-btn downvote ${post.user_downvoted ? 'active' : ''}" onclick="votePost(${post.id}, -1)">&#9660;</button>
                        </div>
                    `;

                    // Post card HTML
                    const postCard = document.createElement('div');
                    postCard.className = 'post';
                    postCard.innerHTML = `
                        <div style="display:flex; align-items:center; margin-bottom:10px;">
                            <img src="${post.profile_pic_url || '/static/default_profile.png'}" alt="Profile" class="profile-pic">
                            <div style="margin-left:10px;">
                                <h3><a href="/post/${post.id}">${post.title}</a></h3>
                                <small>by <em>${post.author}</em> on ${post.created_at}</small>
                            </div>
                        </div>
                        <p>${post.content ? post.content.substring(0, 200) : ''}${post.content && post.content.length > 200 ? '...' : ''}</p>
                        <div>${tagsHTML}</div>
                        ${votesHTML}
                        <a href="/post/${post.id}" style="display:block; margin-top:10px;">Read more</a>
                    `;
                    container.appendChild(postCard);
                });

                postsLoaded = true;
            })
            .catch(err => console.error('Error loading posts:', err));
    }
}

document.getElementById('toggleAllPosts').addEventListener('click', () => {
    const container = document.getElementById('allPostsContainer');
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        loadPosts();
        document.getElementById('toggleAllPosts').innerText = 'Hide All Posts';
    } else {
        container.style.display = 'none';
        document.getElementById('toggleAllPosts').innerText = 'View All Posts';
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('allPostsContainer');
    if (container) container.style.display = 'none';
});
</script>


{% endblock %}
