{% extends "base.html" %}
{% block content %}
<h2>Posts in {{ tag|capitalize }}</h2>
<a href="{{ url_for('home') }}">Back to disciplines</a><br><br>

{% if current_user.is_authenticated %}
  <span id="toggle-post-form" class="toggle-link">Create a post</span>

  <div id="post-form-container" class="hidden" style="margin-top:10px;">
    <form method="POST" action="{{ url_for('submit') }}">
      <input type="text" name="title" placeholder="Post title" required><br><br>
      <textarea name="content" placeholder="Write something..." required></textarea><br><br>
      <input type="hidden" name="tag" value="{{ tag }}">

      <label for="additional_tags">Add up to 4 additional disciplines:</label><br>
      <select id="additional_tags" name="additional_tags" multiple size="6" style="width: 200px;">
        {% for discipline in disciplines %}
          {% if discipline != tag %}
            <option value="{{ discipline }}">{{ discipline|capitalize }}</option>
          {% endif %}
        {% endfor %}
      </select><br>
      <small>Press Ctrl (Cmd on Mac) + Click to select multiple disciplines. You can select up to 4 additional disciplines.</small><br><br>

      <!-- DOIs -->
      <div id="post-doi-list">
        <div class="doi-row" style="margin-bottom:6px;">
          <input type="text" name="dois[]" class="doi-input" placeholder="10.xxxx/xxxx or https://doi.org/..." style="width:340px;">
          <div class="preview" style="font-size:0.9em; color:#333; margin-top:4px;"></div>
        </div>
      </div>
      <button type="button" id="add-doi">+ Add another DOI</button><br><br>

      <button type="submit">Submit</button>
    </form>
    <hr>
  </div>

  <script>
    const togglePostForm = document.getElementById('toggle-post-form');
    const postFormContainer = document.getElementById('post-form-container');

    togglePostForm.addEventListener('click', () => {
      if (postFormContainer.classList.contains('hidden')) {
        postFormContainer.classList.remove('hidden');
        togglePostForm.textContent = 'Hide form';
      } else {
        postFormContainer.classList.add('hidden');
        togglePostForm.textContent = 'Create a post';
      }
    });

    // Add DOI row dynamically
    document.getElementById('add-doi').addEventListener('click', () => {
      const list = document.getElementById('post-doi-list');
      const row = document.createElement('div');
      row.className = 'doi-row';
      row.style.marginBottom = '6px';
      row.innerHTML = `<input type="text" name="dois[]" class="doi-input" placeholder="10.xxxx/xxxx or https://doi.org/..." style="width:340px;">
                       <div class="preview" style="font-size:0.9em; color:#333; margin-top:4px;"></div>`;
      list.appendChild(row);
      attachDoiPreview(row.querySelector('.doi-input'));
    });

    // Attach automatic DOI preview
    function attachDoiPreview(input) {
      input.addEventListener('input', async e => {
        const val = e.target.value.trim();
        const previewDiv = e.target.parentElement.querySelector('.preview');
        if (!val) { previewDiv.textContent = ''; return; }
        previewDiv.textContent = 'Fetching...';
        try {
          const resp = await fetch(`/doi/preview?doi=${encodeURIComponent(val)}`);
          const data = await resp.json();
          if (!data.ok) { previewDiv.textContent = data.error || 'Not found.'; }
          else {
            const d = data.data;
            const authors = (d.authors || []).join(', ');
            const yr = d.year ? ` (${d.year})` : '';
            previewDiv.innerHTML = `<div><strong>${d.title || 'Untitled'}</strong>${yr}</div>
                                    <div>${authors}</div>
                                    <div><a href="${d.url}" target="_blank">${d.identifier}</a></div>`;
          }
        } catch (err) { previewDiv.textContent = 'Error fetching preview.'; }
      });
    }

    document.querySelectorAll('.doi-input').forEach(attachDoiPreview);
  </script>
{% else %}
  <p><a href="{{ url_for('login') }}">Log in</a> to submit a post.</p>
{% endif %}

{% if posts %}
  {% for post in posts %}
    <div class="post" style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc;">
      <h3><a href="{{ url_for('post_detail', post_id=post.id) }}">{{ post.title }}</a></h3>
      {% if post.edited %}
        <span style="color: gray; font-size:0.9em;">(edited)</span>
      {% endif %}
      {% if post.solved %}
        <span style="color: green; font-weight:bold; margin-left:10px;">SOLVED</span>
      {% else %}
        {% if current_user.id == post.user_id %}
          <a href="{{ url_for('toggle_solved', post_id=post.id) }}" style="color: orange; font-weight:bold; margin-left:10px;">Mark as Solved</a>
        {% endif %}
      {% endif %}

      <p>
        by <a href="{{ url_for('profile', username=post.user.username) }}">
            <img src="{{ post.user.get_profile_pic() }}" alt="Profile Picture"
                 style="height:20px; width:20px; border-radius:50%; vertical-align:middle; margin-right:5px;">
            {{ post.user.username }}
        </a> on {{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
      </p>

      <p>Tags:
        {% for t in post.tags %}
          {{ t.name }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      </p>

      {% if post.dois %}
        <div class="references-box">
          <strong>References:</strong>
          <ul style="margin:6px 0 0 18px;">
            {% for d in post.dois %}
              <li>
                {% if d.title %}<em>{{ d.title }}</em>{% else %}{{ d.identifier }}{% endif %}
                {% if d.year %} ({{ d.year }}){% endif %}
                {% if d.authors %} — {{ d.authors }}{% endif %}
                {% if d.url %} — <a href="{{ d.url }}" target="_blank">{{ d.identifier }}</a>{% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
  {% endfor %}
{% else %}
  <p>No posts yet in this discipline.</p>
{% endif %}
{% endblock %}
